\chapter{Verification of Adjoint Sensitivity Gradients}
\label{chapter-seven}

In this section the sensitivity gradients computed by the adjoint-formulation
are verified against finite-difference derivatives with a complex step.  This
details the methods by which the gradient information is computed in the
forward-mode and in the reverse-mode.

\section{Forward-mode Sensitivities Using Complex-Variables}

The sensitivities can be computed in the forward-mode by using
finite-difference.  While this approach is unfavorable to use in practice,
because a minimum number of flow solves equivalent to the number of design
variables are required, it is a straight-forward way to verify that
sensitivities computed by the adjoint solver are correct.  To avoid cancellation
errors associated with real-variable finite difference, an approach that uses
complex variables was originally suggested by Squire and Trapp\cite{squire1998}
and evaluated by Newman et al\cite{newman1998}.  This complex-variable approach
can be used to determine the derivative of a real valued function, $f$, by
considering the Taylor series expansion of $f$ using a complex step $ih$
%------------------------------------------------------------------------------%
\begin{equation}
  f(x + ih) = \sum_{k=0}\left( \frac{(ih)^k}{!k}\pnd{f}{x}{k} \right)
            = f(x) + ih\pd{f}{x} - \frac{h^2}{2}\pnd{f}{x}{2}
            - \frac{h^3}{6}\pnd{f}{x}{3} + \cdots
  \label{taylor-exp}
\end{equation}
%------------------------------------------------------------------------------%
taking the imaginary parts of both sides of \eref{taylor-exp} and solving for
the first derivative yields
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pd{f}{x} &= \frac{Im\left[ f(x + ih) \right]}{h} -
    \frac{h^2}{6}\pnd{f}{x}{3} \\
              &= \frac{Im\left[ f(x + ih) \right]}{h} - O(h^2)
  \end{aligned}
  \label{complex-fd}
\end{equation}
%------------------------------------------------------------------------------%
Thus, this complex-variable approach provides a means of computing the cost
function derivatives without subtractive cancellation error, giving truly second
order accuracy.  The power of using this approach is that the derivative of any
function with respect to a single can be computed without any additional work,
other than the function be made to use complex arithmetic and a complex-valued
perturbation be applied.

In practice, this complex-variable approach is implemented by transforming the
source code such that all real variables used in a function evaluation are made
to be complex variables.  A specified step size is then added to the complex
part of the design variable that the cost function is to be linearized with
respect to in the function evaluation.  Provided the ``complexified'' solver
converges in the same manner as the real-variable solver, the complex part of
the function of interest is the sensitivity derivative.

As mentioned before, the complex-variable and real-variable solvers must
converge to the same solution for the comparison between the adjoint-computed
sensitivity derivatives and those computed by the complex-variable approach to
be valid.  The use of a flux limiter is mandatory for hypersonic applications,
where strong shocks are present; however, the solver is very sensitive to
changes in the reconstruction, and a ``ringing'' of the residual is often
observed\cite{gnoffo2007ringing} when using a flux limiter in FUN3D. While this
sub-convergence of the conservation equation residuals is not detrimental to the
primal flow solver results, as most aerothermodynamic quantities are usually
sufficiently converged by this point, the adjoint-formulation is predicated on
the residual being zero, or at least nearly zero.  Because of this last point,
the stalled convergence can cause the adjoint solver to give incorrect results
or cause the adjoint solution to diverge.  To prevent this, the adjoint is
required to be run with a ``frozen'' limiter, that is only where a
reconstruction is unrealisable is the value of the limiter function changed.
 Doing this usually results in the residuals converging to machine precision.

A significant obstacle with using a frozen limiter is that the real-variable and
complex-variable solvers do not freeze the limiter identically.  Although the
solvers are nearly identically, their floating-point operations will be
different since complex arithmetic is involved in only the complex-variable
solver.  The flux limiter formulation is sensitive to these differences and will
result in a different converged state, regardless of the limiter being frozen
at the same iteration between the solvers.  To overcome this, the
complex-variable solver must not be allowed to change the value of the flux
limiter.  To implement this, the solution is converged to machine precision with
the real-variable solver and then the complex-variable solver is started with
the flow field of the converged real-variable solution.  The complex step is
then added to the design variable; however, the flux limiter is frozen.  Because
limiter value is constant, the real solution from the complex-variable and
real-variable solutions will match identically, and the complex part of the
solution will be converged without ever needing to update the flux limiter.
This will ensure that the sensitivity derivatives from the complex and adjoint
solvers match to high precision for hypersonic cases with a frozen flux limiter.

\section{Verification of 2nd-order Adjoint Linearizations}

To verify the hand-coded linearizations implemented in the adjoint solver, the
derivatives of the drag, surface temperature, and mass flow rate cost functions
components for the annular nozzle geometry were computed using both the adjoint
method and the complex-variable approach.  To facilitate checking the
linearizations of all of these components efficiently, a composite cost function
was formed with a three components
%------------------------------------------------------------------------------%
\begin{equation} f = w_1\left( \massflow - \massflow^{*}\right)^{2} + w_2\left(
  T_{RMS} - T_{RMS}^*\right)^2 + w_3\left( C_{D} - C_{D}^*\right)^2
  \label{check-cost-func} \end{equation}
%------------------------------------------------------------------------------%
By combining all components into a single composite function, only one
real-valued flow and adjoint solution is needed to obtain the sensitivity
derivatives for all design variables, computed by \eref{obj-linearization2}. One
complex-valued flow solution is needed for each design variable.
\tref{tab:pg-deriv-check} shows the comparison between the sensitivity
derivatives computed by \eref{obj-linearization1} and \eref{complex-fd}, for a
perfect gas annular jet simulation.
%------------------------------------------------------------------------------%
\begin{table}[h] \centering \begin{tabular}{c|c|c|c} Design Variable & Adjoint &
    Complex & Difference\\ \hline $P_{p,o}$ & 0.12067860106210E-04 &
    0.12067860106758E-04 & 5.48E-16 \\ $T_{p,o}$ & 0.36654635117980E-03 &
    0.36654635118188E-03 & 2.08E-15 \end{tabular} \caption{Sensitivity
  Derivative Comparison - Perfect Gas} \label{tab:pg-deriv-check} \end{table}
%------------------------------------------------------------------------------%
The adjoint and complex solvers match within machine zero, which is $\sim
10^{-15}$ for this case.  \tref{tab:frozen-deriv-check} shows the same
comparison as that in \tref{tab:pg-deriv-check}, but with a $H_2$-$N_2$ mixture
ejected in a 5-species freestream air mixture with frozen flow
%------------------------------------------------------------------------------%
\begin{table}[h] \centering \begin{tabular}{c|c|c|c} Design Variable & Adjoint &
    Complex & Difference\\ \hline $P_{p,o}$ & -0.18451007644622E-06 &
    -0.184510076442032E-06 & 4.19E-18 \\ $T_{p,o}$ &  0.62086963151678E-03 &
    0.620869631517086E-03 & 3.06E-16 \\ $\fa$     & -0.34045335117520E-01 &
    -0.340453351177196E-01 & 1.20E-13 \end{tabular} \caption{Sensitivity
  Derivative Comparison - $H_2$-$N_2$ Frozen} \label{tab:frozen-deriv-check}
\end{table}
%------------------------------------------------------------------------------%
There is very strong agreement between all the design variable senstivities
computed by the adjoint and complex solvers, with all matching discretely to
within 11 digits.  \tref{tab:react-deriv-check} shows the same comparison as
that in \tref{tab:frozen-deriv-check}, with reactions allowed to take place.
%------------------------------------------------------------------------------%
\begin{table}[h] \centering \begin{tabular}{c|c|c|c} Design Variable & Adjoint &
    Complex & Difference\\ \hline $P_{p,o}$ & -0.11081344492683E-06 &
    -0.110529774659536E-06 & 2.84E-10 \\ $T_{p,o}$ & 0.190899489720282E-03 &
    0.190892847933810E-03 & 6.64E-09 \\ $\fa$     & -0.28035433535237E-01 &
    -0.280251731728184E-01 & 1.03E-05 \end{tabular} \caption{Sensitivity
  Derivative Comparison - $H_2$-$N_2$ Reacting} \label{tab:react-deriv-check}
\end{table}
%------------------------------------------------------------------------------%
It is clear that these do not match as well as those in
\trefs{tab:pg-deriv-check}{tab:frozen-deriv-check}.  The difference is explained
by the temperature dependence of the chemical source term, and the conditioning
of the temperature jacobian matrices.  The dissociation reactions near the
stagnation region and the combustion reactions that occur when $H_2$
auto-ignites in the shock layer are sensitive to the temperature, and account
for a significant numerical stiffness seen in the convergence of the
conservation equation residuals.  This manifests in the residuals stalling at a
much higher value than the previous cases that were run without a chemical
source term.  Due to the non-dimensionalization in the generic gas path of
FUN3D, the condition number of temperature jacobian scales quadratically with
the freestream velocity.  This is discussed thoroughly in Appendix
\ref{temperature-jacobian-conditioning}. Since this is a hypersonic problem,
it can be expected that the conditioning of the temperature jacobian has
impacted the adjoint and complex solve sensitivities.

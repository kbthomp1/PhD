\chapter{Derivations}
\label{derivations}

\section{Decoupled Flux Derivation}

For the Roe flux difference splitting scheme, the species mass fluxes are given by
%------------------------------------------------------------------------------%
\begin{equation}
	F_{\rho_s} = \frac{\rho_s^L\overline{U}^L+\rho_s^R\overline{U}^R}{2}
	-\frac{\tilde{c}_s(\lambda_1 dv_1 + \lambda_2 dv_2)+\lambda_3 dv_{3_s}}{2}
  \label{species-mass} \\
\end{equation}
\begin{align}	
		dv_1 &= \frac{p^R-p^L+\tilde{\rho} \tilde{a} (\overline{U}^R-\overline{U}^L)}{\tilde{a}^2} \\
		dv_2 &= \frac{p^R-p^L-\tilde{\rho} \tilde{a} (\overline{U}^R-\overline{U}^L)}{\tilde{a}^2} \\
		dv_{3_s} &= \frac{\tilde{a}^2 (\rho_s^R-\rho_s^L)- \tilde{c}_s (p^R-p^L)}{\tilde{a}^2}
\end{align}
\begin{align}
	\lambda_1 = \mid\mathbf{\overline{U}}+\tilde{a} \mid,\quad 
	\lambda_2 = \mid \mathbf{\overline{U}}-\tilde{a} \mid,\quad 
	\lambda_3 =  \mid \mathbf{\overline{U}} \mid
\end{align}
%------------------------------------------------------------------------------%
where the $\tilde{}$ notation signifies a Roe-averaged quantity, given by:
%------------------------------------------------------------------------------%
\begin{gather}
	\mathbf{\tilde{U}} =\roe \mathbf{\tilde{U}}^L+(1-\roe)\mathbf{\tilde{U}}^R \\
	\roe = \frac{\tilde{\rho}}{\tilde{\rho}+\rho^R} \\
	\tilde{\rho} = \sqrt{\rho^R\rho^L}
\end{gather}
%------------------------------------------------------------------------------%
The species mass fluxes must sum to the total mass flux; thus, the total mixture
mass flux is given as
%------------------------------------------------------------------------------%
\begin{equation}
\label{total-mass}
	F_\rho = \sum\limits_{s}{F_{\rho_s}} = \frac{\rho^L\overline{U}^L+\rho^R\overline{U}^R}{2}
	-\frac{\lambda_1 dv_1 + \lambda_2 dv_2 +\lambda_3 dv_3}{2}
\end{equation}
\begin{equation}
	dv_3 = \frac{\tilde{a}^2 (\rho^R-\rho^L)-(p^R-p^L)}{\tilde{a}^2}
\end{equation}
%------------------------------------------------------------------------------%
Multiplying \eref{total-mass} by the Roe-averaged mass fraction and
substituting it into \eref{species-mass} results in:
%------------------------------------------------------------------------------%
\begin{equation}
\label{unsimp-sp-flux}
	F_{\rho_s} =\tilde{c}_s F_\rho + \frac{(c_s^L-\tilde{c}_s)\rho^L(\overline{U}^L+\mid \tilde{U}\mid)}{2}
	+ \frac{(c_s^R-\tilde{c}_s)\rho^R(\overline{U}^R-\mid \tilde{U}\mid)}{2}
\end{equation}
%------------------------------------------------------------------------------%
It should be noted here that the Roe-averaged normal velocity, $\tilde{U}$,
requires an entropy correction in the presence of strong shocks\cite{harten}.
This correction has a dependence on the roe-averaged speed of sound, and
therefore has a dependence on the species mass fractions; however,
through numerical experiments it has been determined that omitting this
dependence does not adversely affect convergence.  The notation can be further
simplified by defining the normal velocities as follows:
%------------------------------------------------------------------------------%
\begin{equation}
  \lambda^+ = \frac{\overline{U}^L+\mid \tilde{U}\mid}{2}, \quad 
  \lambda^- = \frac{\overline{U}^R-\mid \tilde{U}\mid}{2} 
  \label{lambda-pm} 
\end{equation}
%------------------------------------------------------------------------------%
Finally, substituting \eref{lambda-pm} into \eref{unsimp-sp-flux} yields the
final result for calculating the species flux in the decoupled system:
%------------------------------------------------------------------------------%
\begin{equation}
  F_{\rho_s} =
  \tilde{c}_s F_\rho 
  + (c_s^L-\tilde{c}_s)\rho^L\lambda^+ 
  + (c_s^R-\tilde{c}_s)\rho^R\lambda^-
  \label{sp-flux} 
\end{equation}
%------------------------------------------------------------------------------%
Forming the convective contributions to the Jacobians is straightforward.
Because the $\mathbf{U}'$ level variables are constant, only the left, right,
and Roe-averaged state mass fractions vary.  Differentiating \eref{sp-flux}
with respect to the mass fraction, $c_s$, the left and right state contributions
are
%------------------------------------------------------------------------------%
\begin{gather}
  \pd{F_{\rho_s}}{c^L_s} = \roe F_\rho+(1-\roe)\rho^L\lambda^+ - \roe \rho^R\lambda^- \\
  \pd{F_{\rho_s}}{c^R_s} = (1-\roe) F_\rho+(\roe-1)\rho^L\lambda^+ + \roe\rho^R\lambda^- 
  \label{dc-sp-linearizations}
\end{gather}
%------------------------------------------------------------------------------%
Because there is no dependence between species in decoupled convective
formulation, the Jacobian block elements are purely diagonal for the convective
contributions, of the form
%------------------------------------------------------------------------------%
\begin{equation} 
  \begin{pmatrix} 
    \pd{F_{\rho_1}}{c_1} & & 0 \\ 
    & \ddots & \\ 
    0 & & \pd{F_{\rho_{ns}}}{c_{ns}}
  \end{pmatrix}
  \label{dc-diag-Jacobian}
\end{equation}
%------------------------------------------------------------------------------%

\section{Quadratic Interpolation Between Thermodynamic Curve Fits}
\label{sec:quad-cp-blending}

We seek to blend the two thermodynamic curve fits in such a way that we maintain
$c_0$ continuity in both specific heat ($C_p$) and enthalpy ($h$).  To
accomplish this, a quadratic function must be used, of the form
%------------------------------------------------------------------------------%
\begin{equation}
  a T^2 + b T + c = C_p
  \label{generic_form}
\end{equation}
%------------------------------------------------------------------------------%
The coefficients $a$, $b$, and $c$ are determined by solving the system that
results from the boundary value problem
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{cases}
    a {T_1}^{2} + b T_1 +c = C_{p_1} \\
    a {T_2}^{2} + b T_2 +c = C_{p_2} \\
    a \frac{\left( {T_2}^{3} - {T_1}^{3}\right) }{3} + b\frac{ \left( {T_2}^{2} - {T_1}^{2}\right) }{2} + c \left( T_2 - T_1\right) = h_2-h_1
  \end{cases}
\end{equation}
%------------------------------------------------------------------------------%
Where the $x_1$ and $x_2$ subscripts describe the left and right states,
respectively.  Solving the linear system, the coefficients are
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{cases}
    a=\frac{3\left( C_{p_2}+ C_{p_1}\right) }{(T_2-T_1)^{2}} - \frac{6 \left(h_2 - h_1\right)}{(T_2-T_1)^{3}}\\ \\
    b=-\frac{2\left[(C_{p_2} + 2C_{p_1})T_2 + (2C_{p_2} + C_{p_1})T_1\right]}{(T_2-T_1)^{2}} + \frac{6(T_2+T_1)(h_2 - h_1)}{(T_2 - T_1)^3}\\ \\
    c=\frac{C_{p_1} T_2 (T_2 + 2T_1) + C_{p_2} T_1 (T_1 + 2 T_2)}{(T_2-T_1)^2} - \frac{6 T_1 T_2 (h_2 - h_1)}{(T_2 - T_1)^3}
  \end{cases}
\end{equation}
%------------------------------------------------------------------------------%
This can be simplified to
%------------------------------------------------------------------------------%
\begin{gather}
  \begin{cases}
    a=3B - A \\ \\
    b=\frac{-2(C_{p_1} T_2 + C_{p_2}T_2)}{(T_2 - T_1)^2} +(T_2+T_1) (A - 2B) \\ \\
    c=\frac{C_{p_1} {T_2}^2 + C_{p_2} {T_1}^2}{(T_2-T_1)^2} + T_1 T_2 (2B - A)
  \end{cases} \\
  A = \frac{6(h_2 - h_1)}{(T_2 - T_1)^3} \\
  B = \frac{C_{p_2} + C_{p_1}}{(T_2 - T_1)^2}
\end{gather}
%------------------------------------------------------------------------------%
Note that this does not ensure that entropy will be continuous across curve
fits.

\section{Temperature Linearizations and Non-Dimensionalization}
\label{temperature-Jacobian-conditioning}

Following the thermodynamic state relations detailed by Gnoffo et al.
\cite{gnoffo-tp}, the derivatives of temperature with respect to the conserved
variable vector
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{T}{Q} =
  \begin{pmatrix}
    \pd{T}{\rho_1} \\
    \vdots \\
    \pd{T}{\rho_{ns}} \\
    \pd{T}{\rho u} \\
    \pd{T}{\rho v} \\
    \pd{T}{\rho w} \\
    \pd{T}{\rho E}
  \end{pmatrix}
  \label{tjac}
\end{equation}
%------------------------------------------------------------------------------%
The derivation of \eref{tjac} begins with the definition of the mixture internal
energy, $e$
%------------------------------------------------------------------------------%
\begin{align}
  e &= \ssum \left( c_s e_s \right) 
  = \ssum \left[ c_s \left( \int_{T_{ref}}^{T} \cvs dT + e_{s,o} \right)\right]
  \label{int-energy} \\
  de &= \ssum \left( dc_s e_s \right) + \ssum \left( c_s \cvs \right) dT
  \label{dint-energy}
\end{align}
%------------------------------------------------------------------------------%
solving \eref{dint-energy} for $dT$
%------------------------------------------------------------------------------%
\begin{equation}
  dT = \frac{de - \ssum \left( dc_s e_s \right)}{C_v}
  \label{dt-de}
\end{equation}
%------------------------------------------------------------------------------%
where $C_v$ is the specific heat at constant volume of the mixture, defined as
%------------------------------------------------------------------------------%
\begin{equation}
  C_v = \ssum \left( c_s \cvs \right)
  \label{cv-mix}
\end{equation}
%------------------------------------------------------------------------------%
to transform \eref{dt-de} into a relation with conserved variables, the
definition of mixture total energy is re-arranged as
%------------------------------------------------------------------------------%
\begin{align}
  \rho E &= \rho e + \frac{1}{2}\left( \rho u^2 + \rho v^2 + \rho w^2 \right) \\
  e &= \frac{\rho E - \frac{1}{2} 
       \left( \rho u^2 + \rho v^2 + \rho w^2 \right)}{\rho} \\
  de &= \frac{
        - \left( e \right) d\rho 
        - \left( u \right) d\rho u
        - \left( v \right) d\rho v
        - \left( w \right) d\rho w
        + d \rho E
         }{\rho}
  \label{rhoe-def}
\end{align}
%------------------------------------------------------------------------------%
substituting \eref{rhoe-def} into \eref{dt-de}, \eref{tjac} can be rewritten as
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{T}{Q} =
  \frac{1}{\rho C_v}
  \begin{pmatrix}
    \frac{\left( \qs \right)}{2} - e_1 \\
    \vdots \\
    \frac{\left( \qs \right)}{2} - e_{ns} \\
    -u \\
    -v \\
    -w \\
    1
  \end{pmatrix}
  \label{tjac-complete}
\end{equation}
%------------------------------------------------------------------------------%

The non-dimensionalization of variables in the generic gas path of FUN3D are
based on freestream dimensional quantities
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \rho &= \rho^{'} / \rho^{'}_{\infty} \\
    u &= u^{'} / V^{'}_{\infty} \\
    v &= v^{'} / V^{'}_{\infty} \\
    w &= w^{'} / V^{'}_{\infty} \\
    e &= e^{'} / \left( V^{'}_{\infty} \right)^2 \\
    T &= T^{'}
  \end{aligned}
  \label{nondim-gg}
\end{equation}
%------------------------------------------------------------------------------%
where $^{'}$ denotes a dimensional quantity. Note that temperature, $T$, is not
non-dimensionalized in FUN3D, due to the large number of table look-ups that have
temperature in dimensional units of Kelvin.  This is an important point when
non-dimensionalizing the mixture specific heat at constant volume, $C_v$.  In
the MKS system, $C_v$ has units $J/kg \cdot K$; therefore the proper
non-dimensionalization using the system in \eref{nondim-gg} is
%------------------------------------------------------------------------------%
\begin{equation}
  C_v = {C_v}^{'}/\left( V^{'}_{\infty} \right)^2
  \label{cv-nondim}
\end{equation}
%------------------------------------------------------------------------------%
Using \erefs{nondim-gg}{cv-nondim}, \eref{tjac-complete} can be rewritten in
terms of dimensional quantities.
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{T}{Q} =
  \frac{\rho^{'}_{\infty}}{\rho^{'} {C_v}^{'}}
  \begin{pmatrix}
    \frac{\left( \qsp \right)}{2} - e^{'}_1 \\
    \vdots \\
    \frac{\left( \qsp \right)}{2} - e^{'}_{ns} \\
    -u^{'}(V^{'}_{\infty}) \\
    -v^{'}(V^{'}_{\infty}) \\
    -w^{'}(V^{'}_{\infty}) \\
    (V^{'}_{\infty})^2
  \end{pmatrix}
  \label{tjac-dim}
\end{equation}
%------------------------------------------------------------------------------%
As the reference velocity becomes large, as is the case in hypersonic problems,
the quadratic scaling of the final linearization in \eref{tjac-dim},
$\pd{T}{\rho E}$ can lead to poor conditioning of the Jacobian matrix.  This is
particular true for the chemical source term, since small changes in temperature
can lead to very large changes in species densities.

\section{Change of Variable Sets}
\label{change-of-var-section}

The decoupled scheme developed by Candler et. al\cite{candler} is based upon the
change of variables
%------------------------------------------------------------------------------%
\begin{equation}
  \mU = \begin{pmatrix}
    \rho_1 \\
    \vdots \\
    \rho_{ns} \\
    \rho \vu \\
    \rho E
  \end{pmatrix}
  \rightarrow
  \mv = \begin{pmatrix}
    c_1 \\
    \vdots \\
    c_{ns} \\
    \rho \\
    \rho \vu \\
    \rho E
  \end{pmatrix}
  \label{var-sets}
\end{equation}
%------------------------------------------------------------------------------%
To avoid confusion between variable sets, we re-write the variable vectors,
$\mU$ and $\mv$, in a more generic sense
%------------------------------------------------------------------------------%
\begin{equation}
  \mU = \begin{pmatrix}
    u_1 \\
    \vdots \\
    u_{ns + 2}
  \end{pmatrix}
  \rightarrow
  \mv = \begin{pmatrix}
    v_1 \\
    \vdots \\
    v_{ns + 3}
  \end{pmatrix}
  \label{generic-var-sets}
\end{equation}
%------------------------------------------------------------------------------%
For simplicity, consider a system with two species, $\rho_1$ and $\rho_2$.
Using the relationship $\rho_s = c_s \rho$, then the original variable vector,
$\mU$ can be rewritten in terms of the new variables, $\mv$ as
%------------------------------------------------------------------------------%
\begin{equation}
  \mU = \begin{pmatrix}
    u_1 \\
    u_2 \\
    u_3 \\
    u_4
  \end{pmatrix}
  =
  \begin{pmatrix}
    v_1 v_3 \\
    v_2 v_3 \\
    v_4 \\
    v_5
  \end{pmatrix}
  \label{u-to-v}
\end{equation}
%------------------------------------------------------------------------------%
This allows the derivation of the Jacobian 
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\mU}{\mv} = 
  \begin{pmatrix}
    \pd{u_1}{v_1} & \pd{u_1}{v_2} & \pd{u_1}{v_3} & \pd{u_1}{v_4} & \pd{u_1}{v_5} \\ \\
    \pd{u_2}{v_1} & \pd{u_2}{v_2} & \pd{u_2}{v_3} & \pd{u_2}{v_4} & \pd{u_2}{v_5} \\ \\
    \pd{u_3}{v_1} & \pd{u_3}{v_2} & \pd{u_3}{v_3} & \pd{u_3}{v_4} & \pd{u_3}{v_5} \\ \\
    \pd{u_4}{v_1} & \pd{u_4}{v_2} & \pd{u_4}{v_3} & \pd{u_4}{v_4} & \pd{u_4}{v_5}
  \end{pmatrix}
  =
  \begin{pmatrix}
    v_3 & 0   & v_1 & 0 & 0 \\ \\
    0   & v_3 & v_2 & 0 & 0 \\ \\
    0   & 0   & 0   & 1 & 0 \\ \\
    0   & 0   & 0   & 0 & 1
  \end{pmatrix}
  \label{dudv-jac}
\end{equation}
%------------------------------------------------------------------------------%
At this point, it is important to note that the Jacobian in \eref{dudv-jac} has
two psuedo-inverse matricies, that correspond to the right and left inverse.
The right inverse, $\pdr{\mv}{\mU}{R}$, can be constructed based on the previously
defined steps
%------------------------------------------------------------------------------%
\begin{equation}
  \pdr{\mv}{\mU}{R} = 
  \begin{pmatrix}
    \pd{v_1}{u_1} & \pd{v_1}{u_2} & \pd{v_1}{u_3} & \pd{v_1}{u_4} \\ \\
    \pd{v_2}{u_1} & \pd{v_2}{u_2} & \pd{v_2}{u_3} & \pd{v_2}{u_4} \\ \\
    \pd{v_3}{u_1} & \pd{v_3}{u_2} & \pd{v_3}{u_3} & \pd{v_3}{u_4} \\ \\
    \pd{v_4}{u_1} & \pd{v_4}{u_2} & \pd{v_4}{u_3} & \pd{v_4}{u_4} \\ \\
    \pd{v_5}{u_1} & \pd{v_5}{u_2} & \pd{v_5}{u_3} & \pd{v_5}{u_4} 
  \end{pmatrix}
  =
  \begin{pmatrix}
    \frac{1-v_1}{v_3} & \frac{-v_1}{v_3}  & 0 & 0 \\ \\
    \frac{-v_2}{v_3}  & \frac{1-v_2}{v_3} & 0 & 0 \\ \\
    1                 & 1                 & 0 & 0 \\ \\
    0                 & 0                 & 1 & 0 \\ \\
    0                 & 0                 & 0 & 1
  \end{pmatrix}
  \label{dvdu-jac-right}
\end{equation}
%------------------------------------------------------------------------------%
It is easily verified that the matrix product of
\erefs{dudv-jac}{dvdu-jac-right} produces identity
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\mU}{\mv} \pdr{\mv}{\mU}{R} = 
  \begin{pmatrix}
    v_3 & 0   & v_1 & 0 & 0 \\ \\
    0   & v_3 & v_2 & 0 & 0 \\ \\
    0   & 0   & 0   & 1 & 0 \\ \\
    0   & 0   & 0   & 0 & 1
  \end{pmatrix}
  \begin{pmatrix}
    \frac{1-v_1}{v_3} & \frac{-v_1}{v_3}  & 0 & 0 \\ \\
    \frac{-v_2}{v_3}  & \frac{1-v_2}{v_3} & 0 & 0 \\ \\
    1                 & 1                 & 0 & 0 \\ \\
    0                 & 0                 & 1 & 0 \\ \\
    0                 & 0                 & 0 & 1
  \end{pmatrix}
  =
  \begin{pmatrix}
    1 & 0 & 0 & 0 \\ \\
    0 & 1 & 0 & 0 \\ \\
    0 & 0 & 1 & 0 \\ \\
    0 & 0 & 0 & 1
  \end{pmatrix}
  \label{dvdu-jac-right-I}
\end{equation}
%------------------------------------------------------------------------------%
however, \eref{dvdu-jac-right-I} is not associative
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pdr{\mv}{\mU}{R} \pd{\mU}{\mv} &= 
    \begin{pmatrix}
      \frac{1-v_1}{v_3} & \frac{-v_1}{v_3}  & 0 & 0 \\ \\
      \frac{-v_2}{v_3}  & \frac{1-v_2}{v_3} & 0 & 0 \\ \\
      1                 & 1                 & 0 & 0 \\ \\
      0                 & 0                 & 1 & 0 \\ \\
      0                 & 0                 & 0 & 1
    \end{pmatrix}
    \begin{pmatrix}
      v_3 & 0   & v_1 & 0 & 0 \\ \\
      0   & v_3 & v_2 & 0 & 0 \\ \\
      0   & 0   & 0   & 1 & 0 \\ \\
      0   & 0   & 0   & 0 & 1
    \end{pmatrix} \\
    &= 
    \begin{pmatrix}
      1-v_1 & -v_1  & \frac{-(v_1)^2 - v_1 v_2 + v_1}{v_3} & 0 & 0 \\ \\
      -v_2  & 1-v_2 & \frac{-(v_2)^2 - v_1 v_2 + v_2}{v_3} & 0 & 0 \\ \\
      0     & 0     & 0                                    & 1 & 0 \\ \\
      0     & 0     & 0                                    & 0 & 1
    \end{pmatrix}
  \end{aligned}
  \label{dvdu-jac-right-I-bad}
\end{equation}
%------------------------------------------------------------------------------%
to correctly compute identity, the property of matrix transpose multiplication
is used
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \left( \pd{\mU}{\mv} \pdr{\mv}{\mU}{R} \right)^T &= 
    {\pdr{\mv}{\mU}{R}}^T {\pd{\mU}{\mv}}^T \\ &=
    \begin{pmatrix}
      \frac{1-v_1}{v_3} & \frac{-v_2}{v_3}  & 1 & 0 & 0 \\ \\
      \frac{-v_1}{v_3}  & \frac{1-v_2}{v_3} & 1 & 0 & 0 \\ \\
      0                 & 1                 & 0 & 1 & 0 \\ \\
      0                 & 0                 & 0 & 0 & 1
    \end{pmatrix}
    \begin{pmatrix}
      v_3 & 0   & 0   & 0 \\ \\
      0   & v_3 & 0   & 0 \\ \\
      v_1 & v_2 & 0   & 0 \\ \\
      0   & 0   & 1   & 0 \\ \\
      0   & 0   & 0   & 1 
    \end{pmatrix} \\
    &= 
    \begin{pmatrix}
      1 & 0 & 0 & 0 \\ \\
      0 & 1 & 0 & 0 \\ \\
      0 & 0 & 1 & 0 \\ \\
      0 & 0 & 0 & 1
    \end{pmatrix}
  \end{aligned}
  \label{dvdu-jac-tranpose}
\end{equation}
%------------------------------------------------------------------------------%
This is critical in understanding the relationships needed to switch transform
variables sets.  For linearizations of the residual, $\mr$, the correct
transformation from the variable set $\mU$ to the variable set $\mv$ is
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\mr}{\mv} = \pd{\mr}{\mU} \pd{\mU}{\mv}
  \label{r-u-to-v}
\end{equation}
%------------------------------------------------------------------------------%
which is intuitively understood; however, the transformation from the variable
set $\mv$ to the variable set $\mU$ must follow \eref{dvdu-jac-tranpose}
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\mr}{\mU} = \left( \pd{\mr}{\mv}^{T} \pd{\mv}{\mU}^{T} \right)^{T}
  \label{r-v-to-u}
\end{equation}
%------------------------------------------------------------------------------%
The transposition in \eref{r-u-to-v} is critical, as the linearizations will be
incorrect if the multiplication is done without it.  Fortunately,
\eref{r-u-to-v} is rarely seen in practice, as most linearizations are done for
the fully-coupled system that requires \eref{r-v-to-u} to transform the
linearizations
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pd{\mr}{\mv} = \pd{\mr}{\mU} \pd{\mU}{\mv} =
    \begin{pmatrix}
      \rdiff{\rho_1}{\rho_1}    & \dots  & \rdiff{\rho_1}{\rho_{ns}}    & \rdiff{\rho_1}{\rho \vu}    & \rdiff{\rho_1}{\rho E}    \\ \\
      \vdots                    & \ddots & \vdots                       & \vdots                      & \vdots                    \\ \\
      \rdiff{\rho_{ns}}{\rho_1} & \dots  & \rdiff{\rho_{ns}}{\rho_{ns}} & \rdiff{\rho_{ns}}{\rho \vu} & \rdiff{\rho_{ns}}{\rho E} \\ \\
      \rdiff{\rho \vu}{\rho_1}  & \dots  & \rdiff{\rho \vu}{\rho_{ns}}  & \rdiff{\rho \vu}{\rho \vu}  & \rdiff{\rho \vu}{\rho E}  \\ \\
      \rdiff{\rho E}{\rho_1}    & \dots  & \rdiff{\rho E}{\rho_{ns}}    & \rdiff{\rho E}{\rho \vu}    & \rdiff{\rho E}{\rho E}
    \end{pmatrix}
    \begin{pmatrix}
      \rho   & \dots  & 0      & c_1     & 0      & 0      \\ \\
      \vdots & \ddots & \vdots & \vdots  & \vdots & \vdots \\ \\
      0      & \dots  &\rho    & c_{ns}  & 0      & 0      \\ \\
      0      & \dots  &0       & 0       & 1      & 0      \\ \\
      0      & \dots  &0       & 0       & 0      & 1
    \end{pmatrix}
  \end{aligned}
  \label{drdu-to-drdv}
\end{equation}
%------------------------------------------------------------------------------%
likewise, in the adjoint the transformation is applied to the tranpose of the 
Jacobian
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pd{\mr}{\mU}^{T} = \pd{\mU}{\mv}^{T} \pd{\mr}{\mU}^{T} =
    \begin{pmatrix}
      \rho   & \dots  & 0      &  0      & 0      \\ \\
      \vdots & \ddots & \vdots &  \vdots & \vdots \\ \\
      0      & \dots  &\rho    &  0      & 0      \\ \\
      c_1    & \dots  & c_{ns} &  0      & 0      \\ \\
      0      & \dots  & 0      &  1      & 0      \\ \\
      0      & \dots  & 0      &  0      & 1
    \end{pmatrix}
    \begin{pmatrix}
      \rdiff{\rho_1}{\rho_1}    & \dots  & \rdiff{\rho_{ns}}{\rho_1}    & \rdiff{\rho \vu}{\rho_1}    & \rdiff{\rho E}{\rho_1} \\ \\
      \vdots                    & \ddots & \vdots                       & \vdots                      & \vdots                   \\ \\
      \rdiff{\rho_1}{\rho_{ns}} & \dots  & \rdiff{\rho_{ns}}{\rho_{ns}} & \rdiff{\rho \vu}{\rho_{ns}} & \rdiff{\rho E}{\rho_{ns}} \\ \\
      \rdiff{\rho_1}{\rho \vu}  & \dots  & \rdiff{\rho_{ns}}{\rho \vu}  & \rdiff{\rho \vu}{\rho \vu}  & \rdiff{\rho E}{\rho \vu} \\ \\
      \rdiff{\rho_1}{\rho E}    & \dots  & \rdiff{\rho_{ns}}{\rho E}    & \rdiff{\rho \vu}{\rho E}    & \rdiff{\rho E}{\rho E}
    \end{pmatrix}
  \end{aligned}
  \label{drdu-to-drdv-t}
\end{equation}
%------------------------------------------------------------------------------%
Since the tranformation is left-multiplied, the matrix vector products of the 
exact Jacobian with costate variables, $\adjlam{}$, in the adjoint linear system
can be done first, and the transformation can then be applied to the system
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pd{\mr}{\mU}^{T} \adjlam{} =
    \begin{pmatrix}
      \rho   & \dots  & 0      &  0      & 0      \\ \\
      \vdots & \ddots & \vdots &  \vdots & \vdots \\ \\
      0      & \dots  &\rho    &  0      & 0      \\ \\
      c_1    & \dots  & c_{ns} &  0      & 0      \\ \\
      0      & \dots  & 0      &  1      & 0      \\ \\
      0      & \dots  & 0      &  0      & 1
    \end{pmatrix}
    \begin{pmatrix}
      \rlprod{\rho_1}{\rho_1}    & \dots  &+& \rlprod{\rho_{ns}}{\rho_1}    &+& \rlprod{\rho \vu}{\rho_1}    &+& \rlprod{\rho E}{\rho_1} \\ \\
      \vdots                     & \ddots & & \vdots                        & & \vdots                       & & \vdots                   \\ \\
      \rlprod{\rho_1}{\rho_{ns}} & \dots  &+& \rlprod{\rho_{ns}}{\rho_{ns}} &+& \rlprod{\rho \vu}{\rho_{ns}} &+& \rlprod{\rho E}{\rho_{ns}} \\ \\
      \rlprod{\rho_1}{\rho \vu}  & \dots  &+& \rlprod{\rho_{ns}}{\rho \vu}  &+& \rlprod{\rho \vu}{\rho \vu}  &+& \rlprod{\rho E}{\rho \vu} \\ \\
      \rlprod{\rho_1}{\rho E}    & \dots  &+& \rlprod{\rho_{ns}}{\rho E}    &+& \rlprod{\rho \vu}{\rho E}    &+& \rlprod{\rho E}{\rho E}
    \end{pmatrix}
  \end{aligned}
  \label{adj-drdv}
\end{equation}
%------------------------------------------------------------------------------%
This indicates the important point that the transformation of the adjoint
residual is not dependent on the number of equations solved, but only the number
of dependent variables the equations are linearized with respect to, namely
$\mU$.

\section{Change of Equation Sets}
\label{sec:change-of-equations}

In addition to a change of variables, the decoupled scheme also changes the
equations being solved, effectively solving is one more equation than the
fully-coupled scheme.  The residual vector for the decoupled scheme, $\rv{}$,
and the residual vector for the fully coupled scheme, $\ru{}$, can be written as
%------------------------------------------------------------------------------%
\begin{equation}
  \ru{} =
  \begin{pmatrix}
    \res{\rho_1} \\ \\
    \vdots \\ \\
    \res{\rho_{N_s}} \\ \\
    \res{\rho \vu} \\ \\
    \res{\rho E}
  \end{pmatrix}
  \rightarrow
  \rv{} =
  \begin{pmatrix}
    \res{\rho_1} - c_1 \resrho \\ \\
    \vdots \\ \\
    \res{\rho_{N_s}} - c_{N_s} \resrho \\ \\
    \resrho \\ \\
    \res{\rho \vu} \\ \\
    \res{\rho E}
  \end{pmatrix}
  \label{fc-dc-res}
\end{equation}
%------------------------------------------------------------------------------%
\eref{fc-dc-res} shows that $\rv{}$ is completely comprised of components from
$\ru{}$; therefore, a relationship between these equation sets can be derived in
a similar fashion to Appendix \ref{change-of-var-section}.  Rewriting $\ru{}$ in
terms of $\rv{}$
%------------------------------------------------------------------------------%
\begin{equation}
  \ru{} =
  \begin{pmatrix}
    \rv{i} + c_i \left(\rv{N_s+1} \right) \\
    \rv{N_s+2} \\
    \rv{N_s+3}
  \end{pmatrix}
  \label{ru-to-rv}
\end{equation}
%------------------------------------------------------------------------------%
It is possible to form the transformation
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\ru{}}{\rv{}} =
  \begin{pmatrix}
    1      & \dots  & 0 & c_1        & 0 & 0 \\
    \vdots & \ddots & \vdots            & \vdots & \vdots & \vdots & \vdots \\
    0      & \dots  & 1 & c_{N_{ns}} & 0 & 0 \\
    0      & \dots  & 0 & 0          & 1 & 0 \\
    0      & \dots  & 0 & 0          & 0 & 1 \\
  \end{pmatrix}
  \label{drudrv}
\end{equation}
%------------------------------------------------------------------------------%
The adjoint costate variable vector $\adjlam{}$ is effectively defined as
%------------------------------------------------------------------------------%
\begin{equation}
  \adjlam{} = \pd{f}{\mr}
  \label{adj-lam-dfdr}
\end{equation}
%------------------------------------------------------------------------------%
Thus, there are two different costate variable vectors for the equation sets
defined in \eref{ru-to-rv}
%------------------------------------------------------------------------------%
\begin{align}
  \adjlam{\mU} = \pd{f}{\ru{}}
  \label{adj-lam-ru} \\[12pt]
  \adjlam{\mv} = \pd{f}{\rv{}}
  \label{adj-lam-rv}
\end{align}
%------------------------------------------------------------------------------%
based on \erefs{adj-lam-ru}{adj-lam-rv}, it clear that the transformation
defined in \eref{drudrv} is the mapping between these costate variable sets
%------------------------------------------------------------------------------%
\begin{equation}
  \adjlam{\mU} = \pd{\ru{}}{\rv{}} \adjlam{\mv}
  \label{adj-ru-to-rv}
\end{equation}
%------------------------------------------------------------------------------%
\eref{adj-ru-to-rv} enables a right preconditioning of the adjoint system of
equations, where the costate variables associated with the decoupled system of
equations can be transformed into the costate variables associated with fully
coupled system of equations, as post-processing step.  This also decreases the
length of the solution vector storage required, since the fully coupled system
has one less equation than the decoupled system.


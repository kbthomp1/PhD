\chapter{Derivations}
\label{derivations}

\section{Decoupled Flux Derivation}
\label{decoupled-flux-derivation}

For the Roe flux difference splitting scheme, the species mass fluxes are given by
%------------------------------------------------------------------------------%
\begin{equation}
	F_{\rho_s} = \frac{\rho_s^L\overline{U}^L+\rho_s^R\overline{U}^R}{2}
	-\frac{\tilde{c}_s(\lambda_1 dv_1 + \lambda_2 dv_2)+\lambda_3 dv_{3_s}}{2}
  \label{species-mass} \\
\end{equation}
\begin{align}	
		dv_1 &= \frac{p^R-p^L+\tilde{\rho} \tilde{a} (\overline{U}^R-\overline{U}^L)}{\tilde{a}^2} \\
		dv_2 &= \frac{p^R-p^L-\tilde{\rho} \tilde{a} (\overline{U}^R-\overline{U}^L)}{\tilde{a}^2} \\
		dv_{3_s} &= \frac{\tilde{a}^2 (\rho_s^R-\rho_s^L)- \tilde{c}_s (p^R-p^L)}{\tilde{a}^2}
\end{align}
\begin{align}
	\lambda_1 = \mid\mathbf{\overline{U}}+\tilde{a} \mid,\quad 
	\lambda_2 = \mid \mathbf{\overline{U}}-\tilde{a} \mid,\quad 
	\lambda_3 =  \mid \mathbf{\overline{U}} \mid
\end{align}
%------------------------------------------------------------------------------%
where the $\tilde{}$ notation signifies a Roe-averaged quantity, given by:
%------------------------------------------------------------------------------%
\begin{gather}
	\mathbf{\tilde{U}} =\roe \mathbf{\tilde{U}}^L+(1-\roe)\mathbf{\tilde{U}}^R \\
	\roe = \frac{\tilde{\rho}}{\tilde{\rho}+\rho^R} \\
	\tilde{\rho} = \sqrt{\rho^R\rho^L}
\end{gather}
%------------------------------------------------------------------------------%
The species mass fluxes must sum to the total mass flux; thus, the total mixture
mass flux is given as
%------------------------------------------------------------------------------%
\begin{equation}
\label{total-mass}
	F_\rho = \sum\limits_{s}{F_{\rho_s}} = \frac{\rho^L\overline{U}^L+\rho^R\overline{U}^R}{2}
	-\frac{\lambda_1 dv_1 + \lambda_2 dv_2 +\lambda_3 dv_3}{2}
\end{equation}
\begin{equation}
	dv_3 = \frac{\tilde{a}^2 (\rho^R-\rho^L)-(p^R-p^L)}{\tilde{a}^2}
\end{equation}
%------------------------------------------------------------------------------%
Multiplying \eref{total-mass} by the Roe-averaged mass fraction and
substituting it into \eref{species-mass} results in:
%------------------------------------------------------------------------------%
\begin{equation}
\label{unsimp-sp-flux}
	F_{\rho_s} =\tilde{c}_s F_\rho + \frac{(c_s^L-\tilde{c}_s)\rho^L(\overline{U}^L+\mid \tilde{U}\mid)}{2}
	+ \frac{(c_s^R-\tilde{c}_s)\rho^R(\overline{U}^R-\mid \tilde{U}\mid)}{2}
\end{equation}
%------------------------------------------------------------------------------%
It should be noted here that the Roe-averaged normal velocity, $\tilde{U}$,
requires an entropy correction in the presence of strong shocks\cite{harten}.
This correction has a dependence on the roe-averaged speed of sound, and
therefore has a dependence on the species mass fractions; however,
through numerical experiments it has been determined that omitting this
dependence does not adversely affect convergence.  The notation can be further
simplified by defining the normal velocities as follows:
%------------------------------------------------------------------------------%
\begin{equation}
  \lambda^+ = \frac{\overline{U}^L+\mid \tilde{U}\mid}{2}, \quad 
  \lambda^- = \frac{\overline{U}^R-\mid \tilde{U}\mid}{2} 
  \label{lambda-pm} 
\end{equation}
%------------------------------------------------------------------------------%
Finally, substituting \eref{lambda-pm} into \eref{unsimp-sp-flux} yields the
final result for calculating the species flux in the decoupled system:
%------------------------------------------------------------------------------%
\begin{equation}
  F_{\rho_s} =
  \tilde{c}_s F_\rho 
  + (c_s^L-\tilde{c}_s)\rho^L\lambda^+ 
  + (c_s^R-\tilde{c}_s)\rho^R\lambda^-
  \label{sp-flux} 
\end{equation}
%------------------------------------------------------------------------------%
Forming the convective contributions to the Jacobians is straightforward.
Because the $\mathbf{U}'$ level variables are constant, only the left, right,
and Roe-averaged state mass fractions vary.  Differentiating \eref{sp-flux}
with respect to the mass fraction, $c_s$, the left and right state contributions
are
%------------------------------------------------------------------------------%
\begin{gather}
  \pd{F_{\rho_s}}{c^L_s} = \roe F_\rho+(1-\roe)\rho^L\lambda^+ - \roe \rho^R\lambda^- \\
  \pd{F_{\rho_s}}{c^R_s} = (1-\roe) F_\rho+(\roe-1)\rho^L\lambda^+ + \roe\rho^R\lambda^- 
  \label{dc-sp-linearizations}
\end{gather}
%------------------------------------------------------------------------------%
Because there is no dependence between species in decoupled convective
formulation, the Jacobian block elements are purely diagonal for the convective
contributions, of the form
%------------------------------------------------------------------------------%
\begin{equation} 
  \begin{pmatrix} 
    \pd{F_{\rho_1}}{c_1} & & 0 \\ 
    & \ddots & \\ 
    0 & & \pd{F_{\rho_{N_s}}}{c_{N_s}}
  \end{pmatrix}
  \label{dc-diag-Jacobian}
\end{equation}
%------------------------------------------------------------------------------%

\section{Quadratic Interpolation Between Thermodynamic Curve Fits}
\label{sec:quad-cp-blending}

We seek to blend the two thermodynamic curve fits in such a way that we maintain
$c_0$ continuity in both specific heat ($C_p$) and enthalpy ($h$).  To
accomplish this, a quadratic function must be used, of the form
%------------------------------------------------------------------------------%
\begin{equation}
  a T^2 + b T + c = C_p
  \label{generic_form}
\end{equation}
%------------------------------------------------------------------------------%
The coefficients $a$, $b$, and $c$ are determined by solving the system that
results from the boundary value problem
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{cases}
    a {T_1}^{2} + b T_1 +c = C_{p_1} \\
    a {T_2}^{2} + b T_2 +c = C_{p_2} \\
    a \frac{\left( {T_2}^{3} - {T_1}^{3}\right) }{3} + b\frac{ \left( {T_2}^{2} - {T_1}^{2}\right) }{2} + c \left( T_2 - T_1\right) = h_2-h_1
  \end{cases}
\end{equation}
%------------------------------------------------------------------------------%
Where the $x_1$ and $x_2$ subscripts describe the left and right states,
respectively.  Solving the linear system, the coefficients are
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{cases}
    a=\frac{3\left( C_{p_2}+ C_{p_1}\right) }{(T_2-T_1)^{2}} - \frac{6 \left(h_2 - h_1\right)}{(T_2-T_1)^{3}}\\ \\
    b=-\frac{2\left[(C_{p_2} + 2C_{p_1})T_2 + (2C_{p_2} + C_{p_1})T_1\right]}{(T_2-T_1)^{2}} + \frac{6(T_2+T_1)(h_2 - h_1)}{(T_2 - T_1)^3}\\ \\
    c=\frac{C_{p_1} T_2 (T_2 + 2T_1) + C_{p_2} T_1 (T_1 + 2 T_2)}{(T_2-T_1)^2} - \frac{6 T_1 T_2 (h_2 - h_1)}{(T_2 - T_1)^3}
  \end{cases}
\end{equation}
%------------------------------------------------------------------------------%
This can be simplified to
%------------------------------------------------------------------------------%
\begin{gather}
  \begin{cases}
    a=3B - A \\ \\
    b=\frac{-2(C_{p_1} T_2 + C_{p_2}T_2)}{(T_2 - T_1)^2} +(T_2+T_1) (A - 2B) \\ \\
    c=\frac{C_{p_1} {T_2}^2 + C_{p_2} {T_1}^2}{(T_2-T_1)^2} + T_1 T_2 (2B - A)
  \end{cases} \\
  A = \frac{6(h_2 - h_1)}{(T_2 - T_1)^3} \\
  B = \frac{C_{p_2} + C_{p_1}}{(T_2 - T_1)^2}
\end{gather}
%------------------------------------------------------------------------------%
Note that this does not ensure that entropy will be continuous across curve
fits.

\section{Change of Variable Sets}
\label{change-of-var-section}

The decoupled scheme developed by Candler et. al\cite{candler} is based upon the
change of variables
%------------------------------------------------------------------------------%
\begin{equation}
  \mU = \begin{pmatrix}
    \rho_1 \\
    \vdots \\
    \rho_{N_s} \\
    \rho \vu \\
    \rho E
  \end{pmatrix}
  \rightarrow
  \mv = \begin{pmatrix}
    c_1 \\
    \vdots \\
    c_{N_s} \\
    \rho \\
    \rho \vu \\
    \rho E
  \end{pmatrix}
  \label{var-sets}
\end{equation}
%------------------------------------------------------------------------------%
To avoid confusion between variable sets, we re-write the variable vectors,
$\mU$ and $\mv$, in a more generic sense
%------------------------------------------------------------------------------%
\begin{equation}
  \mU = \begin{pmatrix}
    u_1 \\
    \vdots \\
    u_{N_s + 2}
  \end{pmatrix}
  \rightarrow
  \mv = \begin{pmatrix}
    v_1 \\
    \vdots \\
    v_{N_s + 3}
  \end{pmatrix}
  \label{generic-var-sets}
\end{equation}
%------------------------------------------------------------------------------%
For simplicity, consider a system with two species, $\rho_1$ and $\rho_2$.
Using the relationship $\rho_s = c_s \rho$, then the original variable vector,
$\mU$ can be rewritten in terms of the new variables, $\mv$ as
%------------------------------------------------------------------------------%
\begin{equation}
  \mU = \begin{pmatrix}
    u_1 \\
    u_2 \\
    u_3 \\
    u_4
  \end{pmatrix}
  =
  \begin{pmatrix}
    v_1 v_3 \\
    v_2 v_3 \\
    v_4 \\
    v_5
  \end{pmatrix}
  \label{u-to-v}
\end{equation}
%------------------------------------------------------------------------------%
This allows the derivation of the Jacobian 
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\mU}{\mv} = 
  \begin{pmatrix}
    \pd{u_1}{v_1} & \pd{u_1}{v_2} & \pd{u_1}{v_3} & \pd{u_1}{v_4} & \pd{u_1}{v_5} \\ \\
    \pd{u_2}{v_1} & \pd{u_2}{v_2} & \pd{u_2}{v_3} & \pd{u_2}{v_4} & \pd{u_2}{v_5} \\ \\
    \pd{u_3}{v_1} & \pd{u_3}{v_2} & \pd{u_3}{v_3} & \pd{u_3}{v_4} & \pd{u_3}{v_5} \\ \\
    \pd{u_4}{v_1} & \pd{u_4}{v_2} & \pd{u_4}{v_3} & \pd{u_4}{v_4} & \pd{u_4}{v_5}
  \end{pmatrix}
  =
  \begin{pmatrix}
    v_3 & 0   & v_1 & 0 & 0 \\ \\
    0   & v_3 & v_2 & 0 & 0 \\ \\
    0   & 0   & 0   & 1 & 0 \\ \\
    0   & 0   & 0   & 0 & 1
  \end{pmatrix}
  \label{dudv-jac}
\end{equation}
%------------------------------------------------------------------------------%
At this point, it is important to note that the Jacobian in \eref{dudv-jac} has
two psuedo-inverse matricies, that correspond to the right and left inverse.
The right inverse, $\pdr{\mv}{\mU}{R}$, can be constructed based on the previously
defined steps
%------------------------------------------------------------------------------%
\begin{equation}
  \pdr{\mv}{\mU}{R} = 
  \begin{pmatrix}
    \pd{v_1}{u_1} & \pd{v_1}{u_2} & \pd{v_1}{u_3} & \pd{v_1}{u_4} \\ \\
    \pd{v_2}{u_1} & \pd{v_2}{u_2} & \pd{v_2}{u_3} & \pd{v_2}{u_4} \\ \\
    \pd{v_3}{u_1} & \pd{v_3}{u_2} & \pd{v_3}{u_3} & \pd{v_3}{u_4} \\ \\
    \pd{v_4}{u_1} & \pd{v_4}{u_2} & \pd{v_4}{u_3} & \pd{v_4}{u_4} \\ \\
    \pd{v_5}{u_1} & \pd{v_5}{u_2} & \pd{v_5}{u_3} & \pd{v_5}{u_4} 
  \end{pmatrix}
  =
  \begin{pmatrix}
    \frac{1-v_1}{v_3} & \frac{-v_1}{v_3}  & 0 & 0 \\ \\
    \frac{-v_2}{v_3}  & \frac{1-v_2}{v_3} & 0 & 0 \\ \\
    1                 & 1                 & 0 & 0 \\ \\
    0                 & 0                 & 1 & 0 \\ \\
    0                 & 0                 & 0 & 1
  \end{pmatrix}
  \label{dvdu-jac-right}
\end{equation}
%------------------------------------------------------------------------------%
It is easily verified that the matrix product of
\erefs{dudv-jac}{dvdu-jac-right} produces identity
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\mU}{\mv} \pdr{\mv}{\mU}{R} = 
  \begin{pmatrix}
    v_3 & 0   & v_1 & 0 & 0 \\ \\
    0   & v_3 & v_2 & 0 & 0 \\ \\
    0   & 0   & 0   & 1 & 0 \\ \\
    0   & 0   & 0   & 0 & 1
  \end{pmatrix}
  \begin{pmatrix}
    \frac{1-v_1}{v_3} & \frac{-v_1}{v_3}  & 0 & 0 \\ \\
    \frac{-v_2}{v_3}  & \frac{1-v_2}{v_3} & 0 & 0 \\ \\
    1                 & 1                 & 0 & 0 \\ \\
    0                 & 0                 & 1 & 0 \\ \\
    0                 & 0                 & 0 & 1
  \end{pmatrix}
  =
  \begin{pmatrix}
    1 & 0 & 0 & 0 \\ \\
    0 & 1 & 0 & 0 \\ \\
    0 & 0 & 1 & 0 \\ \\
    0 & 0 & 0 & 1
  \end{pmatrix}
  \label{dvdu-jac-right-I}
\end{equation}
%------------------------------------------------------------------------------%
however, \eref{dvdu-jac-right-I} is not associative
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pdr{\mv}{\mU}{R} \pd{\mU}{\mv} &= 
    \begin{pmatrix}
      \frac{1-v_1}{v_3} & \frac{-v_1}{v_3}  & 0 & 0 \\ \\
      \frac{-v_2}{v_3}  & \frac{1-v_2}{v_3} & 0 & 0 \\ \\
      1                 & 1                 & 0 & 0 \\ \\
      0                 & 0                 & 1 & 0 \\ \\
      0                 & 0                 & 0 & 1
    \end{pmatrix}
    \begin{pmatrix}
      v_3 & 0   & v_1 & 0 & 0 \\ \\
      0   & v_3 & v_2 & 0 & 0 \\ \\
      0   & 0   & 0   & 1 & 0 \\ \\
      0   & 0   & 0   & 0 & 1
    \end{pmatrix} \\
    &= 
    \begin{pmatrix}
      1-v_1 & -v_1  & \frac{-(v_1)^2 - v_1 v_2 + v_1}{v_3} & 0 & 0 \\ \\
      -v_2  & 1-v_2 & \frac{-(v_2)^2 - v_1 v_2 + v_2}{v_3} & 0 & 0 \\ \\
      0     & 0     & 0                                    & 1 & 0 \\ \\
      0     & 0     & 0                                    & 0 & 1
    \end{pmatrix}
  \end{aligned}
  \label{dvdu-jac-right-I-bad}
\end{equation}
%------------------------------------------------------------------------------%
to correctly compute identity, the property of matrix transpose multiplication
is used
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \left( \pd{\mU}{\mv} \pdr{\mv}{\mU}{R} \right)^T &= 
    {\pdr{\mv}{\mU}{R}}^T {\pd{\mU}{\mv}}^T \\ &=
    \begin{pmatrix}
      \frac{1-v_1}{v_3} & \frac{-v_2}{v_3}  & 1 & 0 & 0 \\ \\
      \frac{-v_1}{v_3}  & \frac{1-v_2}{v_3} & 1 & 0 & 0 \\ \\
      0                 & 1                 & 0 & 1 & 0 \\ \\
      0                 & 0                 & 0 & 0 & 1
    \end{pmatrix}
    \begin{pmatrix}
      v_3 & 0   & 0   & 0 \\ \\
      0   & v_3 & 0   & 0 \\ \\
      v_1 & v_2 & 0   & 0 \\ \\
      0   & 0   & 1   & 0 \\ \\
      0   & 0   & 0   & 1 
    \end{pmatrix} \\
    &= 
    \begin{pmatrix}
      1 & 0 & 0 & 0 \\ \\
      0 & 1 & 0 & 0 \\ \\
      0 & 0 & 1 & 0 \\ \\
      0 & 0 & 0 & 1
    \end{pmatrix}
  \end{aligned}
  \label{dvdu-jac-tranpose}
\end{equation}
%------------------------------------------------------------------------------%
This is critical in understanding the relationships needed to switch transform
variables sets.  For linearizations of the residual, $\mr$, the correct
transformation from the variable set $\mU$ to the variable set $\mv$ is
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\mr}{\mv} = \pd{\mr}{\mU} \pd{\mU}{\mv}
  \label{r-u-to-v}
\end{equation}
%------------------------------------------------------------------------------%
which is intuitively understood; however, the transformation from the variable
set $\mv$ to the variable set $\mU$ must follow \eref{dvdu-jac-tranpose}
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\mr}{\mU} = \left( \pd{\mr}{\mv}^{T} \pd{\mv}{\mU}^{T} \right)^{T}
  \label{r-v-to-u}
\end{equation}
%------------------------------------------------------------------------------%
The transposition in \eref{r-u-to-v} is critical, as the linearizations will be
incorrect if the multiplication is done without it.  Fortunately,
\eref{r-u-to-v} is rarely seen in practice, as most linearizations are done for
the fully-coupled system that requires \eref{r-v-to-u} to transform the
linearizations
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pd{\mr}{\mv} = \pd{\mr}{\mU} \pd{\mU}{\mv} =
    \begin{pmatrix}
      \rdiff{\rho_1}{\rho_1}    & \dots  & \rdiff{\rho_1}{\rho_{N_s}}    & \rdiff{\rho_1}{\rho \vu}    & \rdiff{\rho_1}{\rho E}    \\ \\
      \vdots                    & \ddots & \vdots                       & \vdots                      & \vdots                    \\ \\
      \rdiff{\rho_{N_s}}{\rho_1} & \dots  & \rdiff{\rho_{N_s}}{\rho_{N_s}} & \rdiff{\rho_{N_s}}{\rho \vu} & \rdiff{\rho_{N_s}}{\rho E} \\ \\
      \rdiff{\rho \vu}{\rho_1}  & \dots  & \rdiff{\rho \vu}{\rho_{N_s}}  & \rdiff{\rho \vu}{\rho \vu}  & \rdiff{\rho \vu}{\rho E}  \\ \\
      \rdiff{\rho E}{\rho_1}    & \dots  & \rdiff{\rho E}{\rho_{N_s}}    & \rdiff{\rho E}{\rho \vu}    & \rdiff{\rho E}{\rho E}
    \end{pmatrix}
    \begin{pmatrix}
      \rho   & \dots  & 0      & c_1     & 0      & 0      \\ \\
      \vdots & \ddots & \vdots & \vdots  & \vdots & \vdots \\ \\
      0      & \dots  &\rho    & c_{N_s}  & 0      & 0      \\ \\
      0      & \dots  &0       & 0       & 1      & 0      \\ \\
      0      & \dots  &0       & 0       & 0      & 1
    \end{pmatrix}
  \end{aligned}
  \label{drdu-to-drdv}
\end{equation}
%------------------------------------------------------------------------------%
likewise, in the adjoint the transformation is applied to the tranpose of the 
Jacobian
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pd{\mr}{\mU}^{T} = \pd{\mU}{\mv}^{T} \pd{\mr}{\mU}^{T} =
    \begin{pmatrix}
      \rho   & \dots  & 0      &  0      & 0      \\ \\
      \vdots & \ddots & \vdots &  \vdots & \vdots \\ \\
      0      & \dots  &\rho    &  0      & 0      \\ \\
      c_1    & \dots  & c_{N_s} &  0      & 0      \\ \\
      0      & \dots  & 0      &  1      & 0      \\ \\
      0      & \dots  & 0      &  0      & 1
    \end{pmatrix}
    \begin{pmatrix}
      \rdiff{\rho_1}{\rho_1}    & \dots  & \rdiff{\rho_{N_s}}{\rho_1}    & \rdiff{\rho \vu}{\rho_1}    & \rdiff{\rho E}{\rho_1} \\ \\
      \vdots                    & \ddots & \vdots                       & \vdots                      & \vdots                   \\ \\
      \rdiff{\rho_1}{\rho_{N_s}} & \dots  & \rdiff{\rho_{N_s}}{\rho_{N_s}} & \rdiff{\rho \vu}{\rho_{N_s}} & \rdiff{\rho E}{\rho_{N_s}} \\ \\
      \rdiff{\rho_1}{\rho \vu}  & \dots  & \rdiff{\rho_{N_s}}{\rho \vu}  & \rdiff{\rho \vu}{\rho \vu}  & \rdiff{\rho E}{\rho \vu} \\ \\
      \rdiff{\rho_1}{\rho E}    & \dots  & \rdiff{\rho_{N_s}}{\rho E}    & \rdiff{\rho \vu}{\rho E}    & \rdiff{\rho E}{\rho E}
    \end{pmatrix}
  \end{aligned}
  \label{drdu-to-drdv-t}
\end{equation}
%------------------------------------------------------------------------------%
Since the tranformation is left-multiplied, the matrix vector products of the 
exact Jacobian with costate variables, $\adjlam{}$, in the adjoint linear system
can be done first, and the transformation can then be applied to the system
%------------------------------------------------------------------------------%
\begin{equation}
  \begin{aligned}
    \pd{\mr}{\mU}^{T} \adjlam{} =
    \begin{pmatrix}
      \rho   & \dots  & 0      &  0      & 0      \\ \\
      \vdots & \ddots & \vdots &  \vdots & \vdots \\ \\
      0      & \dots  &\rho    &  0      & 0      \\ \\
      c_1    & \dots  & c_{N_s} &  0      & 0      \\ \\
      0      & \dots  & 0      &  1      & 0      \\ \\
      0      & \dots  & 0      &  0      & 1
    \end{pmatrix}
    \begin{pmatrix}
      \rlprod{\rho_1}{\rho_1}    & \dots  &+& \rlprod{\rho_{N_s}}{\rho_1}    &+& \rlprod{\rho \vu}{\rho_1}    &+& \rlprod{\rho E}{\rho_1} \\ \\
      \vdots                     & \ddots & & \vdots                        & & \vdots                       & & \vdots                   \\ \\
      \rlprod{\rho_1}{\rho_{N_s}} & \dots  &+& \rlprod{\rho_{N_s}}{\rho_{N_s}} &+& \rlprod{\rho \vu}{\rho_{N_s}} &+& \rlprod{\rho E}{\rho_{N_s}} \\ \\
      \rlprod{\rho_1}{\rho \vu}  & \dots  &+& \rlprod{\rho_{N_s}}{\rho \vu}  &+& \rlprod{\rho \vu}{\rho \vu}  &+& \rlprod{\rho E}{\rho \vu} \\ \\
      \rlprod{\rho_1}{\rho E}    & \dots  &+& \rlprod{\rho_{N_s}}{\rho E}    &+& \rlprod{\rho \vu}{\rho E}    &+& \rlprod{\rho E}{\rho E}
    \end{pmatrix}
  \end{aligned}
  \label{adj-drdv}
\end{equation}
%------------------------------------------------------------------------------%
This indicates the important point that the transformation of the adjoint
residual is not dependent on the number of equations solved, but only the number
of dependent variables the equations are linearized with respect to, namely
$\mU$.

\section{Change of Equation Sets}
\label{sec:change-of-equations}

In addition to a change of variables, the decoupled scheme also changes the
equations being solved, effectively solving is one more equation than the
fully-coupled scheme.  The residual vector for the decoupled scheme, $\rv{}$,
and the residual vector for the fully coupled scheme, $\ru{}$, can be written as
%------------------------------------------------------------------------------%
\begin{equation}
  \ru{} =
  \begin{pmatrix}
    \res{\rho_1} \\ \\
    \vdots \\ \\
    \res{\rho_{N_s}} \\ \\
    \res{\rho \vu} \\ \\
    \res{\rho E}
  \end{pmatrix}
  \rightarrow
  \rv{} =
  \begin{pmatrix}
    \res{\rho_1} - c_1 \resrho \\ \\
    \vdots \\ \\
    \res{\rho_{N_s}} - c_{N_s} \resrho \\ \\
    \resrho \\ \\
    \res{\rho \vu} \\ \\
    \res{\rho E}
  \end{pmatrix}
  \label{fc-dc-res}
\end{equation}
%------------------------------------------------------------------------------%
\eref{fc-dc-res} shows that $\rv{}$ is completely comprised of components from
$\ru{}$; therefore, a relationship between these equation sets can be derived in
a similar fashion to Appendix \ref{change-of-var-section}.  Rewriting $\rv{}$ in
terms of $\ru{}$
%------------------------------------------------------------------------------%
\begin{equation}
  \rv{} =
  \begin{pmatrix}
    \ru{s} - c_s \left( \lsum{i=1}{N_s}{\ru{i}} \right) \\
    \lsum{i=1}{N_s}{\ru{i}} \\
    \ru{N_s + 1} \\
    \ru{N_s + 2}
  \end{pmatrix}
  \label{ru-to-rv}
\end{equation}
%------------------------------------------------------------------------------%
it is possible to form the transformation
%------------------------------------------------------------------------------%
\begin{equation}
  \pd{\rv{}}{\ru{}} =
  \begin{pmatrix}
    1 - c_1  & -c_1     & \dots  & -c_1      & 0      & 0      \\
    -c_2     & 1-c_2    & \dots  & -c_2      & 0      & 0      \\
    \vdots   & \vdots   & \ddots & \vdots    & \vdots & \vdots \\
    -c_{N_s} & -c_{N_s} & \dots  & 1-c_{N_s} & 0      & 0      \\
    1        & 1        & \dots  & 1         & 0      & 0      \\
    0        & 0        & \dots  & 0         & 1      & 0      \\
    0        & 0        & \dots  & 0         & 0      & 1      \\
  \end{pmatrix}
  \label{drudrv}
\end{equation}
%------------------------------------------------------------------------------%
Because all transformations performed on the equation set are also performed
on the adjoint costate variables, \eref{drudrv} enables the mapping between the
costate variables associated with the fully coupled and decoupled flow solver
equations
%------------------------------------------------------------------------------%
\begin{equation}
  \adjlam{\mU} = \left(\pd{\rv{}}{\ru{}} \right)^{T} \adjlam{\mv}
  \label{adj-ru-to-rv}
\end{equation}
%------------------------------------------------------------------------------%
where costate variables associated with the fully coupled flow solver equations,
$\adjlam{\mU}$, come from solving
%------------------------------------------------------------------------------%
\begin{equation}
  \drudu \adjlam{\mU} = -\pd{f}{\mU}
  \label{fc-adjoint}
\end{equation}
%------------------------------------------------------------------------------%
and the costate variables associated with the decoupled flow solver equations,
$\adjlam{\mv}$, come from solving
%------------------------------------------------------------------------------%
\begin{equation}
  \drvdv \adjlam{\mv} = -\pd{f}{\mv}
  \label{dc-adjoint}
\end{equation}
%------------------------------------------------------------------------------%
\eref{adj-ru-to-rv} faciliates a right preconditioning of \eref{fc-adjoint} to
transform the adjoint solution as post-processing step.  This also decreases the
length of the solution vector storage required, since the fully coupled system
has one less equation than the decoupled system.

